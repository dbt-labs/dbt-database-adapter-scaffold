name: Tests and Code Checks

on:
  push:
    - "main"
    - "develop"
    - "*.latest"
    - "releases/*"
  pull_request:
  workflow_dispatch:

  permissions: read-all

  # will cancel previous workflows triggered by the same event and for the same ref for PRs or same SHA otherwise
  concurrency:
    group: ${{ github.workflow }}-${{ github.event_name }}-${{ contains(github.event_name, 'pull_request') && github.event.pull_request.head.ref || github.sha }}
    cancel-in-progress: true

  defaults:
    run:
      shell: bash

    jobs:
      code-quality:
        name: code-quality

      runs-on: ubuntu-latest

      steps:
        - name: Check out the repository
          uses: actions/checkout@v2
          with:
            persist-credentials: false

        - name: Set up Python
          uses: actions/setup-python@v2

        - name: Install python dependencies
          run: |
            pip install --user --upgrade pip
            pip install pre-commit
            pip install mypy==0.782
            pip install -r dev_requirements.txt
            pip --version
            pre-commit --version
            mypy --version
            dbt --version
        - name: Run pre-commit hooks
          run: pre-commit run --all-files --show-diff-on-failure